# 项目理解
本文基于当前 Workspace（React/Vite 前端项目）梳理了系统架构、模块进度、数据流与已知问题，并提出需要澄清的点以及我主导的“评测结果展示模块”的实施方案与里程碑。

## 一、项目背景与目标
- 项目定位：为可口可乐公司开发销售人员能力评测网站，涵盖题库管理、测评、结果展示与分析。
- 目标用户：销售人员（参与测评）、管理员（维护题库与查看统计）。
- 主要目标：
  - 高质量题库管理与导入（支持场景题、非场景题、渠道、难度、能力标签）。
  - 个性化测评生成与完整作答体验（导航、计时、进度、题型支持）。
  - 准确展示测评结果（总体、难度、能力维度分析），并支持详细解析与改进建议。

## 二、系统架构总览
- 技术栈：React + Vite + react-router-dom + Tailwind CSS + lucide-react 图标。
- 前端状态管理：React Context（QuestionContext、AuthContext）。
- 持久化存储：localStorage（无后端服务）。
- 路由结构：
  - “/”：Dashboard（受保护）
  - “/login”：登录
  - “/question-bank”：题库管理（管理员）
  - “/quiz/:quizId”：测评页面（受保护）
  - “/results/:resultId”：测评结果页（受保护）
  - “/review/:resultId”：详细解析页（受保护）
- 页面/组件关键文件：
  - App.jsx：总路由 + 受保护访问控制
  - pages/QuestionBank.jsx：题库管理页面
  - components/QuestionBankImporter.jsx：题库导入 UI（解析预览、导入、报告）
  - pages/Quiz.jsx：测评页面（题目展示、作答、提交）
  - pages/Results.jsx：结果展示（总体、难度、能力、雷达图、建议）
  - pages/Review.jsx：详细解析（场景题 30 道）
  - context/QuestionContext.jsx：题库、测评、结果相关状态与方法
  - utils/testGenerationService.js：个性化测评生成与结构验证

## 三、核心模块与当前进度
1. 认证与权限   
   - 已实现 AuthProvider + ProtectedRoute。
   - 支持管理员专属页面（题库管理）。

2. 题库管理模块（已完成，持续优化）   
   - 支持列表、搜索、编辑、删除。
   - 场景管理（ScenarioManagement）与题库导入（QuestionBankImporter.jsx）。
   - 导入 UI 提供解析预览、有效/无效数据统计、渠道/能力分布报告。
   - 数据持久化键：
     - coca_cola_questions
     - coca_cola_scenarios
   - 说明：脚本 src/scripts/importFullQuestionBank.js 依赖 src/utils/questionBankImporter.js，但 utils 目录中当前没有该文件；导入 UI 实际使用的是 QuestionContext 内的 parseMarkdownContent。这存在实现重复与路径不一致的问题，需统一（详见“需要澄清的问题”）。

3. 测评模块（已完成，持续优化）   
   - 个性化测评生成：在 QuestionContext 中调用 TestGenerationService 生成结构化测验。
   - 结构校验（validateTest）：确保 60 题；其中场景题 30、渠道题 10、通用题 20。
   - 测评页面 Quiz.jsx：
     - 题目导航、进度条、计时器、题型标识（支持多选题 isMultipleChoice）、用户信息采集（TestUserInfoModal）。
     - 作答数据初始化：为每题预置答案容器（多选为数组，单选为 null）。
     - 提交时调用 submitQuiz 产出结果并导航到结果页。
     
4. 评测结果展示模块（已进入开发）   
   - Results.jsx：
     - 从 localStorage 读取结果（键 coca_cola_results），匹配路由参数 resultId。
     - 成绩总览、难度统计。
     - 7 项能力展示 + 雷达图（现已改为基于题目真实能力标签统计）。
     - 改进建议模块。
   - Review.jsx：
     - 详细解析页面，目前限制只展示前 30 道场景题，并有说明文字。
     - 显示题干、选项、用户答案、正确答案、解析、场景文本。

5. 数据存储与键名（统一为 coca_cola_*）   
   - coca_cola_questions
   - coca_cola_scenarios
   - coca_cola_quizzes
   - coca_cola_results

## 四、数据模型与处理流程
- Question（题目）核心字段（不同来源可能存在差异）：  
  - id、content、options[]、correctAnswer（单选为索引，多选可能为数组）
  - difficulty（easy|medium|hard）
  - channel（如 cvs、ecommerce 等）
  - capability（如“1.全域洞察力”等）
  - isMultipleChoice（布尔）
  - questionType（场景题/渠道题/通用题/非场景题）
  - scenarioId（若属于某场景）
  - explanation（解析文本或结构化解析）
  - category（professional/general）

- Scenario（场景）：  
  - id、title、content、questions[]

- Quiz（测验）：  
  - id、questions[]、createdAt、completed、userInfo（姓名、渠道、职级等）

- Result（测评结果）：  
  - id、quizId、userId、totalQuestions、correctAnswers、score
  - questionResults[]：包含 questionId、question（题干文本）、userAnswer、correctAnswer、isCorrect、options、explanation、difficulty
  - difficultyStats：各难度正确率统计
  - completedAt

- 生成与提交流程：
  1. 生成测验（generatePersonalizedTest -> 验证结构 -> 保存至 coca_cola_quizzes）。
  2. 用户作答（Quiz.jsx 管理状态）。
  3. 提交测验（submitQuiz -> 生成 Result -> 保存至 coca_cola_results -> 导航到 /results/:resultId）。
  4. 结果展示与详细解析（Results.jsx、Review.jsx）。

## 五、已知问题与修复情况
- 能力统计不准确：已将 Results.jsx 的 7 项能力统计逻辑改为基于每题真实 capability 标签的统计（从 result.questionResults 中读取）。
- 解析页面范围：已明确仅展示前 30 道场景题的解析，其它题暂不展示解析，并在页面加注说明。
- “未找到测试结果”问题：  
  - 已统一 localStorage 键名为 coca_cola_results；Results.jsx 使用该键读取。
  - 但从用户截图看，出现 “Result not found @ Results.jsx:19”，说明当前环境中 localStorage 读取到的结果列表为空（例如：历史键名不一致、缓存被清除、提交未写入等）。
  - 建议的稳健性改进：
    1. Results.jsx 增加回退读取旧键名（如 testResults）与 Context 的 getResult(id) 方法，以提升兼容性。
    2. 提交后导航前在控制台打印 result.id 并确认 localStorage 状态，若为空则提示用户刷新或重试。
    3. 在 QuestionProvider 初始化时，若检测到旧键名存在则自动迁移到新键名。
  - 说明：即便用户仅答 10 题，submitQuiz 仍会生成完整结果并保存。出现 not found 的主要原因通常是键名不匹配或 localStorage 状态异常（如隐私/无痕模式或其他脚本清空）。
- 导入脚本与工具路径不一致：  
  - importFullQuestionBank.js 依赖 utils/questionBankImporter.js，但当前 utils 目录仅有 testGenerationService.js。
  - 实际导入逻辑由 QuestionContext.parseMarkdownContent 与 QuestionBankImporter.jsx 承担。
  - 需确认是否保留脚本式导入（控制台 quickImport）并统一解析库位置。

## 六、待澄清的问题（请确认）
1. 7 大能力的最终权威定义及展示名称   
   - IMPORT_GUIDE.md 中的官方分类为：
     - 全域洞察力、客户经营力、故事沟通力、敏捷协作力、规划执行力、完美执行力、自我驱动力。
   - 目前 Results.jsx 使用了一套不同名称（如 2.方案规划力、4.卖进谈判力、7.战略领导力）。请确认最终标准名称与编码（key），我将统一全站展示与统计映射。
   **回答**：7大能力的正确名称是全域洞察力、方案规划力、故事沟通力、卖进谈判力、客户发展力、卓越执行力、战略领导力

2. 多选题评分规则   
   - 当前 submitQuiz 仅做了“严格相等”判断（userAnswer === correctAnswer）。若存在多选题，是否需要部分得分或必须全选正确才判定正确？请提供评分细则（如每个选项权重、半对是否得分）。
   **回答**：多选题必须全选正确才判定正确。其他情况均判定错误

3. 非场景题解析是否暂不展示   
   - Review.jsx 已限制只展示前 30 道场景题解析。是否需要在后续版本补充渠道题/通用题的解析展示？
   - 若不展示，是否在结果页中明确说明“解析仅限场景题”，目前已加说明但可优化展示位置与文案。
   **回答**：只展示30到场景题解析，请在结果页中明确说明“解析仅限场景题”，目前已加说明但可优化展示位置与文案

4. 结果页展示期望   
   - 总体数据：分数、正确题数、总题数、用时（是否需要记录与展示用时？目前计时存在，但未写入结果）。
   - 难度统计：是否需要显示各难度的“作答数/正确数/正确率”，目前有统计但可优化 UI。
   - 能力统计：是否需要展示子能力维度（如“1.1 从数据到洞察”），以及每项能力的“出题数/正确数/正确率”。
   - 雷达图：是否需要支持 hover 提示与响应式缩放、导出图片？
   **回答**：需要展示以下内容
        - 评测总分、正确题数、总题数、三种难度分别的答题正确率
        - 雷达图需要展示7项能力的正确率分布，并且需要同时展示答题者的“得分雷达线”和同一年度中，在测试结果数据库中与答题者相同职级的“平均得分雷达线”
        - 需要增加详细分析模块，展示子能力维度下，每项能力的“出题数/正确数/正确率”，并且用“红、黄、绿灯”显示评估结果。正确率≥80%，绿灯；<60%，红灯；其他情况，黄灯
        - 需要将现在“改进建议”模块改成《未来的我致现在的我的一封信》，这封信要调用大模型API在每次测评后根据测评结果进行输出，包括四段内容：a.结合测评中，测评者的亮点，进行肯定；b.指出测评中，发现的测评者能力缺口；c.结合测评者的能力缺口，给出2~3项可采取的最小化行动；d.对测评者进行鼓励。这封信需要有温情感，让测评者看了之后会因为受到触动而采取最小化行动成长自我

5. 数据持久化与历史记录   
   - 是否需要“历史结果列表”页面、导出 PDF/Excel、分享链接等能力？
   - 是否需要管理员查看团队或渠道聚合统计？如需要，则需要服务端或更完整的前端持久化方案。
   **回答**：需要“历史结果列表”页面，让测评者看到自己的进步，但展示不需要导出功能。需要给管理员查看分职级和分渠道的聚合统计。

6. 题库导入统一方案   
   - 是否保留控制台快速导入脚本（importFullQuestionBank.js）？若保留，需要补齐 utils/questionBankImporter.js 或迁移到 QuestionContext 的解析函数。
   - 能力标签解析格式是否固定为“X.Y 子能力名称”？例如“1.1 从数据到洞察”，系统应如何将子能力与大能力聚合？
   **回答**：需要保留题库批量导入功能，在能实现该功能的前提下，如果不需要importFullQuestionBank.js也行；能力标签解析格式有两种为“X.Y 子能力名称”（如“2.3客户生意规划”）或“X.Y.Z 子能力名称”（如“2.2.5财务解决方案”），其中X对应大能力项编号（如“2.3客户生意规划”和“2.2.5财务解决方案”都属于“2.方案规划力”

7. 业务合规与隐私   
   - 用户信息字段（姓名、渠道、职级）是否需要脱敏或加密存储？
   - localStorage 是否满足生产要求？是否需要后端存储与审计？
   **回答**：用户信息字段（姓名、渠道、职级）不需要脱敏或加密储存，localStorage 只用于测试环境，后续需要储存在云端上。开始时先用免费的云服务器，客户通过后再迁移到可口可乐公司指定的服务器

## 七、评测结果展示模块实施方案（我来主导）
目标：基于真实题目标签，准确、清晰地展示测评结果，包含总体、难度与能力维度分析，并提供详细解析与改进建议。

1. 数据获取与健壮性   
   - Results.jsx 引入 QuestionContext，优先通过 getResult(resultId) 获取结果；若失败再回退 localStorage（coca_cola_results、旧键名 testResults）。
   - 初始化时检测旧键并自动迁移到新键，减少“未找到测试结果”的概率。
   - 在 submitQuiz 后对结果写入进行校验与日志记录（可在开发环境打开）。

2. 能力统计与雷达图   
   - 统一能力映射：以 CAPABILITIES 常量为单一数据源，避免硬编码不一致。
   - 能力统计逻辑：遍历 questionResults，根据 question.capability 汇总“总题数/正确数/正确率”；对缺失能力标签的题记录为“未标注”，并在导入报告中计数。
   - 雷达图：支持响应式、hover 提示；对统计缺失的能力维度进行 UI 提示。

3. 难度与结构统计   
   - 显示 “易/中/难”三档统计（总数/正确数/正确率），并在 UI 中采用一致颜色体系。
   - 同时展示结构分布（场景题 30、渠道题 10、通用题 20），与作答情况对齐。

4. 改进建议   
   - 基于能力与难度表现动态生成建议（例如：某能力正确率低于阈值则推送学习建议）。
   - 后续可扩展：结合子能力维度给出更细颗粒的建议。

5. 详细解析（Review.jsx）   
   - 继续仅展示场景题解析（30 道），强化说明与导航体验。
   - 多选题答案对比优化（数组比对与高亮），场景文本与题目解析结构化展示。
   - 若后续需要渠道/通用题解析，统一解析格式与开关配置。

6. 导出与分享（可选）   
   - 提供 PDF 导出与图片导出（雷达图截图）。
   - 历史结果列表页面与搜索过滤（按时间、用户、渠道、得分）。

## 八、里程碑计划
- 里程碑 0：确认规格与能力映射（本周）  
  - 与您对齐 7 大能力最终定义、展示名称与 key 编码。
  - 确认多选题评分规则与是否支持子能力维度展示。

- 里程碑 1：稳定数据读取与兼容（本周）  
  - Results.jsx 接入 Context + localStorage 双通道读取，增加旧键名迁移。
  - 修复“未找到测试结果”的边缘情况，并加日志辅助定位。

- 里程碑 2：能力统计与雷达图完善（下周）  
  - 基于 CAPABILITIES 统一统计，完善 UI 与提示。
  - 增强雷达图交互与响应式。

- 里程碑 3：难度与结构统计优化（下周）  
  - 完善易/中/难统计卡片与样式，补充结构分布展示。

- 里程碑 4：改进建议引擎（下周）  
  - 定义规则与阈值，输出针对性建议文案。

- 里程碑 5：详细解析优化（下周）  
  - 多选题解析优化、场景内容展示一致性。
  - 明确非场景题解析策略（暂不展示或逐步开放）。

- 里程碑 6：QA 与交付（两周内）  
  - 覆盖主要用户场景与异常场景测试。
  - 文档与导出能力完善。
  
## 九、我方建议与风险提示
- 建议将“题库解析”逻辑统一到 QuestionContext 或独立 utils 并写明版本/规范，避免脚本与 UI 两套解析逻辑互相偏差。
- localStorage 适合 PoC 或内网试点；如需正式上线与数据统计，建议后端化存储与权限审计。
- 多选题评分需尽快明确，否则统计与建议会偏差。
- 能力与子能力的最终命名与显示策略需统一（中文/编码/排序），避免图表与导入报告不一致。
