# 场景题库导入功能优化方案

## 1. 问题分析

当前题库导入功能存在以下问题：
- **场景数量识别错误**：将包含30个场景的题库文件错误地识别为38个场景。
- **场景内容导入失败**：虽然提示导入了38个场景，但实际上只成功导入了第一个场景，其余场景的描述和关联题目均未导入。
- **数据关联错误**：导入的题目未能与正确的场景进行关联。

根本原因在于当前的解析逻辑无法正确识别和处理`QuestionBank.txt`中“场景题”的层级结构和数据格式。

## 2. 场景题与非场景题结构分析

通过分析 `完整题库0803` (`QuestionBank.txt`)，我们总结出场景题与非场景题的识别依据：

### 场景题结构

场景题在文档中具有清晰的层级结构，可以通过特定的Markdown标题格式进行识别：

- **一级标题 (`#`)**: 使用 `# 场景题` 标记场景题部分的开始。所有场景题都位于此标题下。
- **二级标题 (`##`)**: 使用 `## [渠道名称]` (例如, `## CVS`, `## 大卖场/超市`) 定义一个渠道。
- **三级标题 (`###`)**: 使用 `### 场景[场景号]：[场景标题]` (例如, `### 场景1：危机环境下的市场洞察与机会识别`) 或 `### 场景[场景号]` 定义一个具体的场景。场景的详细描述紧跟在该标题之后，直到第一个问题出现。
- **问题格式**: 每个场景下包含5个问题，格式为 `第[题号]题（[难度]）- [能力点]`.

**示例:**
```
# 场景题
## CVS
### 场景1
你是可口可乐公司负责华东区域便利店渠道的KAM...
...
面对这个复杂的竞争局面，你需要基于数据洞察制定相应的应对策略。

第1题（易）- 1.1从数据到洞察
...
```

### 非场景题结构

非场景题位于`# 场景题`部分之后，或者在没有`# 场景题`标题的文件中。它们通常是独立的问答对，没有场景描述的上下文。

- **结构**: 通常以 `第[题号]题` 开头，或者直接是问题文本，不依赖于前置的场景描述。
- **识别**: 所有不在 `# 场景题` -> `## [渠道]` -> `### [场景]` 结构下的题目都可被视为非场景题。

## 3. 导入实现路径

为了正确导入场景题，需要重构当前的解析和导入逻辑。建议采用状态机或逐行扫描的方式进行解析。

### 步骤1：文件解析与数据提取

1.  **初始化状态**: 定义变量来存储当前解析的上下文，例如 `currentChannel`, `currentScenario`, `isParsingScenarioDescription`。
2.  **逐行读取文件**: 遍历文件的每一行。
3.  **状态判断与切换**:
    -   如果行匹配 `## [渠道名称]`，更新 `currentChannel` 并重置 `currentScenario`。
    -   如果行匹配 `### 场景[场景号]...`，则表示一个新的场景开始。
        -   创建一个新的场景对象，并从该行提取场景编号、标题（可选）。
        -   设置 `currentScenario` 为这个新对象。
        -   设置 `isParsingScenarioDescription = true`，开始捕获场景描述。
    -   如果 `isParsingScenarioDescription` 为 `true` 且当前行不是一个问题（即不以 `第[题号]题` 开头），则将该行内容追加到 `currentScenario.description`。
    -   如果行匹配 `第[题号]题...`，则表示场景描述结束，`isParsingScenarioDescription = false`。此时开始解析问题。
        -   解析问题编号、难度、能力点、问题文本、选项和答案。
        -   创建一个新的问题对象。
        -   将 `currentScenario` 的信息（如场景ID）关联到这个问题对象上。
        -   将问题对象添加到一个全局的问题列表中。
4.  **数据清洗**: 清理每行前后可能存在的空格。

### 步骤2：数据模型设计

需要确保数据模型能够支持场景与问题的关联。

-   **Scenario Model**:
    -   `id`: 唯一标识
    -   `title`: 场景标题 (e.g., "危机环境下的市场洞察与机会识别")
    -   `channel`: 所属渠道 (e.g., "CVS")
    -   `description`: 场景的详细描述文本。
    -   `order`: 场景在渠道内的顺序（从1到6）。

-   **Question Model**:
    -   `id`: 唯一标识
    -   `scenarioId`: 关联的场景ID (对于非场景题，此字段为空)。
    -   `text`: 问题文本。
    -   `options`: 选项数组。
    -   `answer`: 正确答案。
    -   `difficulty`: 难度。
    -   `capability`: 考察的能力点。
    -   `category`: 题目分类 (e.g., "专业题", "通用题")。
    -   `channel`: 所属渠道 (对于场景题，继承自场景)。

### 步骤3：导入逻辑

1.  **解析**: 调用新的解析器处理上传的 `.txt` 或 `.md` 文件，生成场景列表和问题列表。
2.  **存储**:
    -   遍历场景列表，将每个场景存入数据库（或 `localStorage`），生成唯一的 `scenarioId`。
    -   遍历问题列表，如果问题有关联的场景，则将对应的 `scenarioId` 存入问题记录中。
3.  **返回结果**: 返回成功导入的场景数量和问题数量。

### 步骤4：测验功能调整

为了满足测验要求，需要对测验页面逻辑进行调整。

1.  **题目获取**: `generateQuiz` 函数需要能够根据渠道和场景顺序来组织题目。
2.  **测验流程**:
    -   开始一个渠道的测验时，首先获取该渠道的 `场景1`。
    -   在UI上显示 `场景1` 的描述。
    -   按顺序展示与 `场景1` 关联的5道题目。
    -   当5道题全部答完后，UI切换到 `场景2`，显示其描述和对应的5道题。
    -   以此类推，直到该渠道所有场景的题目都完成。

这个方案将确保场景和问题能够被正确地解析、关联和存储，从而解决当前导入功能存在的问题，并为后续的测验功能提供可靠的数据基础。